"use strict";
var fs = require('fs-extra');
var path = require('path');
var temp = require('temp');
var Promise = require('bluebird');
temp.track();
var tempDir = temp.mkdirSync('ensime-temp-files');
var getTempDir = function () { return tempDir; };
var getTempPath = function (file) {
    if (process.platform == 'win32')
        return path.join(getTempDir(), file.replace(':', ""));
    else
        return path.join(getTempDir(), file);
};
var withTempFile = function (filePath, bufferText) {
    var tempFilePath = getTempPath(filePath);
    var p = Promise.defer();
    fs.outputFile(tempFilePath, bufferText, function (err) {
        if (err)
            p.reject("error with file");
        else
            p.resolve(tempFilePath);
    });
    return p.promise;
};
function apiOf(client) {
    function getCompletions(filePath, bufferText, offset, noOfAutocompleteSuggestions) {
        return withTempFile(filePath, bufferText).then(function (tempFile) {
            var msg = {
                typehint: "CompletionsReq",
                fileInfo: {
                    file: filePath,
                    contentsIn: tempFile
                },
                point: offset,
                maxResults: noOfAutocompleteSuggestions,
                caseSens: false,
                reload: true
            };
            return client.post(msg);
        });
    }
    function getSymbolAtPoint(path, offset) {
        return new Promise(function (resolve, reject) {
            var req = {
                typehint: "SymbolAtPointReq",
                file: path,
                point: offset
            };
            client.post(req).then(function (msg) {
                if (msg.typehint == 'SymbolInfo')
                    resolve(msg);
                else
                    reject("no symbol response");
            });
        });
    }
    function typecheckBuffer(path, text) {
        withTempFile(path, text).then(function (tempFilePath) {
            var msg = {
                typehint: "TypecheckFileReq",
                fileInfo: {
                    file: path,
                    contentsIn: tempFilePath
                }
            };
            return client.post(msg);
        });
    }
    function typecheckFile(path) {
        var msg = {
            typehint: "TypecheckFileReq",
            fileInfo: {
                file: path
            }
        };
        return client.post(msg);
    }
    function symbolByName(qualifiedName) {
        var msg = {
            typehint: 'SymbolByNameReq',
            typeFullName: qualifiedName
        };
        return client.post(msg);
    }
    function formatSourceFile(path, contents, callback) {
        return withTempFile(path, contents).then(function (tempFilePath) {
            var req = {
                typehint: "FormatOneSourceReq",
                file: {
                    file: path,
                    contentsIn: tempFilePath
                }
            };
            return client.post(req);
        });
    }
    function getImplicitInfo(path, startO, endO) {
        var msg = {
            "typehint": "ImplicitInfoReq",
            "file": path,
            "range": {
                "from": startO,
                "to": endO
            }
        };
        return client.post(msg);
    }
    function typecheckAll() {
        client.post({ "typehint": "TypecheckAllReq" });
    }
    function unloadAll() {
        client.post({ "typehint": "UnloadAllReq" });
    }
    function getRefactoringPatch(procId, refactoring) {
        var req = {
            typehint: 'RefactorReq',
            procId: procId,
            params: refactoring,
            interactive: false
        };
        return client.post(req);
    }
    function searchPublicSymbols(keywords, maxSymbols) {
        return client.post({
            typehint: "PublicSymbolSearchReq",
            keywords: keywords,
            maxResults: maxSymbols
        });
    }
    function getDocUriAtPoint(file, point) {
        return client.post({
            typehint: "DocUriAtPointReq",
            file: file,
            point: point
        });
    }
    function getImportSuggestions(file, characterIndex, symbol) {
        return client.post({
            typehint: 'ImportSuggestionsReq',
            file: file,
            point: characterIndex,
            names: [symbol],
            maxResults: 10
        });
    }
    return {
        getCompletions: getCompletions,
        getSymbolAtPoint: getSymbolAtPoint,
        typecheckFile: typecheckFile,
        typecheckBuffer: typecheckBuffer,
        symbolByName: symbolByName,
        formatSourceFile: formatSourceFile,
        getImplicitInfo: getImplicitInfo,
        typecheckAll: typecheckAll,
        unloadAll: unloadAll,
        getRefactoringPatch: getRefactoringPatch,
        searchPublicSymbols: searchPublicSymbols,
        getDocUriAtPoint: getDocUriAtPoint,
        getImportSuggestions: getImportSuggestions
    };
}
exports.apiOf = apiOf;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXJ2ZXItYXBpL3NlcnZlci1hcGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLElBQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUMvQixJQUFZLElBQUksV0FBTSxNQUFNLENBQUMsQ0FBQTtBQUM3QixJQUFZLElBQUksV0FBTSxNQUFNLENBQUMsQ0FBQTtBQUU3QixJQUFZLE9BQU8sV0FBTSxVQUN6QixDQUFDLENBRGtDO0FBR25DLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtBQUNaLElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUNwRCxJQUFNLFVBQVUsR0FBRyxjQUFNLE9BQUEsT0FBTyxFQUFQLENBQU8sQ0FBQTtBQUVoQyxJQUFNLFdBQVcsR0FBRyxVQUFDLElBQUk7SUFDdkIsRUFBRSxDQUFBLENBQUMsT0FBTyxDQUFDLFFBQVEsSUFBSSxPQUFPLENBQUM7UUFDN0IsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUN2RCxJQUFJO1FBQ0YsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUE7QUFDeEMsQ0FBQyxDQUFBO0FBRUQsSUFBTSxZQUFZLEdBQUcsVUFBQyxRQUFnQixFQUFFLFVBQWtCO0lBQ3RELElBQU0sWUFBWSxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMzQyxJQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsS0FBSyxFQUFVLENBQUM7SUFDbEMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEVBQUUsVUFBVSxFQUFFLFVBQUMsR0FBRztRQUN4QyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUM7WUFDSixDQUFDLENBQUMsTUFBTSxDQUFDLGlCQUFp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QyxJQUFJLENBQUM7WUFDZixRQUFRLEVBQUUsa0JBQWtCO1lBQzVCLElBQUksRUFBRSxJQUFJO1lBQ1YsS0FBSyxFQUFFLEtBQUs7U0FDZixDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsOEJBQThCLElBQVksRUFBRSxjQUFzQixFQUFFLE1BQWM7UUFDOUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7WUFDZixRQUFRLEVBQUUsc0JBQXNCO1lBQ2hDLElBQUksRUFBRSxJQUFJO1lBQ1YsS0FBSyxFQUFFLGNBQWM7WUFDckIsS0FBSyxFQUFFLENBQUMsTUFBTSxDQUFDO1lBQ2YsVUFBVSxFQUFFLEVBQUU7U0FDakIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELE1BQU0sQ0FBQztRQUNILGdCQUFBLGNBQWM7UUFDZCxrQkFBQSxnQkFBZ0I7UUFDaEIsZUFBQSxhQUFhO1FBQ2IsaUJBQUEsZUFBZTtRQUNmLGNBQUEsWUFBWTtRQUNaLGtCQUFBLGdCQUFnQjtRQUNoQixpQkFBQSxlQUFlO1FBQ2YsY0FBQSxZQUFZO1FBQ1osV0FBQSxTQUFTO1FBQ1QscUJBQUEsbUJBQW1CO1FBQ25CLHFCQUFBLG1CQUFtQjtRQUNuQixrQkFBQSxnQkFBZ0I7UUFDaEIsc0JBQUEsb0JBQW9CO0tBQ3ZCLENBQUE7QUFDTCxDQUFDO0FBdkplLGFBQUssUUF1SnBCLENBQUEiLCJmaWxlIjoibGliL3NlcnZlci1hcGkvc2VydmVyLWFwaS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyB0ZW1wIGZyb20gJ3RlbXAnO1xuaW1wb3J0IHtTZXJ2ZXJDb25uZWN0aW9ufSBmcm9tICcuL3NlcnZlci1jb25uZWN0aW9uJ1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmltcG9ydCB7VHlwZWhpbnRlZCwgU3ltYm9sSW5mbywgQ29tcGxldGlvbnNSZXNwb25zZSwgUmVmYWN0b3JpbmdEZXNjLCBQb2ludH0gZnJvbSAnLi9zZXJ2ZXItcHJvdG9jb2wnXG5cbnRlbXAudHJhY2soKVxuY29uc3QgdGVtcERpciA9IHRlbXAubWtkaXJTeW5jKCdlbnNpbWUtdGVtcC1maWxlcycpO1xuY29uc3QgZ2V0VGVtcERpciA9ICgpID0+IHRlbXBEaXJcblxuY29uc3QgZ2V0VGVtcFBhdGggPSAoZmlsZSkgPT4ge1xuICBpZihwcm9jZXNzLnBsYXRmb3JtID09ICd3aW4zMicpXG4gICAgcmV0dXJuIHBhdGguam9pbihnZXRUZW1wRGlyKCksIGZpbGUucmVwbGFjZSgnOicsIFwiXCIpKVxuICBlbHNlXG4gICAgcmV0dXJuIHBhdGguam9pbihnZXRUZW1wRGlyKCksIGZpbGUpXG59XG5cbmNvbnN0IHdpdGhUZW1wRmlsZSA9IChmaWxlUGF0aDogc3RyaW5nLCBidWZmZXJUZXh0OiBzdHJpbmcpIDogUHJvbWlzZUxpa2U8c3RyaW5nPiA9PiB7XG4gICAgY29uc3QgdGVtcEZpbGVQYXRoID0gZ2V0VGVtcFBhdGgoZmlsZVBhdGgpO1xuICAgIGNvbnN0IHAgPSBQcm9taXNlLmRlZmVyPHN0cmluZz4oKTtcbiAgICBmcy5vdXRwdXRGaWxlKHRlbXBGaWxlUGF0aCwgYnVmZmVyVGV4dCwgKGVycikgPT4ge1xuICAgICAgICBpZiAoZXJyKVxuICAgICAgICAgICAgcC5yZWplY3QoXCJlcnJvciB3aXRoIGZpbGVcIik7XG4gICAgICAgIGVsc2UgXG4gICAgICAgICAgICBwLnJlc29sdmUodGVtcEZpbGVQYXRoKTtcbiAgICB9KTtcbiAgICByZXR1cm4gcC5wcm9taXNlOyBcbn0gXG5cblxuZXhwb3J0IGZ1bmN0aW9uIGFwaU9mKGNsaWVudDogU2VydmVyQ29ubmVjdGlvbik6IEFwaSB7XG4gICAgZnVuY3Rpb24gZ2V0Q29tcGxldGlvbnMoZmlsZVBhdGg6IHN0cmluZywgYnVmZmVyVGV4dDogc3RyaW5nLCBvZmZzZXQ6IG51bWJlciwgbm9PZkF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIHdpdGhUZW1wRmlsZShmaWxlUGF0aCwgYnVmZmVyVGV4dCkudGhlbigodGVtcEZpbGUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1zZyA9IHtcbiAgICAgICAgICAgICAgICB0eXBlaGludDogXCJDb21wbGV0aW9uc1JlcVwiLFxuICAgICAgICAgICAgICAgIGZpbGVJbmZvOiB7XG4gICAgICAgICAgICAgICAgICAgIGZpbGU6IGZpbGVQYXRoLFxuICAgICAgICAgICAgICAgICAgICBjb250ZW50c0luOiB0ZW1wRmlsZVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcG9pbnQ6IG9mZnNldCxcbiAgICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBub09mQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbnMsXG4gICAgICAgICAgICAgICAgY2FzZVNlbnM6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHJlbG9hZDogdHJ1ZVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGNsaWVudC5wb3N0KG1zZyk7XG4gICAgICAgIH0pO1xuICAgIH0gXG5cbiAgICBmdW5jdGlvbiBnZXRTeW1ib2xBdFBvaW50KHBhdGg6IHN0cmluZywgb2Zmc2V0KSA6IFByb21pc2VMaWtlPFR5cGVoaW50ZWQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPFR5cGVoaW50ZWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlcSA9IHtcbiAgICAgICAgICAgICAgICB0eXBlaGludDogXCJTeW1ib2xBdFBvaW50UmVxXCIsXG4gICAgICAgICAgICAgICAgZmlsZTogcGF0aCxcbiAgICAgICAgICAgICAgICBwb2ludDogb2Zmc2V0XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjbGllbnQucG9zdChyZXEpLnRoZW4oKG1zZykgPT4ge1xuICAgICAgICAgICAgICAgIGlmKG1zZy50eXBlaGludCA9PSAnU3ltYm9sSW5mbycpIFxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG1zZyk7XG4gICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICByZWplY3QoXCJubyBzeW1ib2wgcmVzcG9uc2VcIik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgICAgICBcbiAgICBmdW5jdGlvbiB0eXBlY2hlY2tCdWZmZXIocGF0aDogc3RyaW5nLCB0ZXh0OiBzdHJpbmcpIHtcbiAgICAgICAgd2l0aFRlbXBGaWxlKHBhdGgsIHRleHQpLnRoZW4oKHRlbXBGaWxlUGF0aCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbXNnID0ge1xuICAgICAgICAgICAgICAgIHR5cGVoaW50OiBcIlR5cGVjaGVja0ZpbGVSZXFcIixcbiAgICAgICAgICAgICAgICBmaWxlSW5mbzoge1xuICAgICAgICAgICAgICAgICAgICBmaWxlOiBwYXRoLFxuICAgICAgICAgICAgICAgICAgICBjb250ZW50c0luOiB0ZW1wRmlsZVBhdGhcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gY2xpZW50LnBvc3QobXNnKTtcbiAgICAgICAgfSk7XG4gICAgfSBcblxuICAgIGZ1bmN0aW9uIHR5cGVjaGVja0ZpbGUocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IG1zZyA9IHtcbiAgICAgICAgICAgIHR5cGVoaW50OiBcIlR5cGVjaGVja0ZpbGVSZXFcIixcbiAgICAgICAgICAgIGZpbGVJbmZvOiB7XG4gICAgICAgICAgICAgICAgZmlsZTogcGF0aFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjbGllbnQucG9zdChtc2cpO1xuICAgIH0gXG5cbiAgICBmdW5jdGlvbiBzeW1ib2xCeU5hbWUocXVhbGlmaWVkTmFtZSkge1xuICAgICAgICBjb25zdCBtc2cgPSB7XG4gICAgICAgICAgICB0eXBlaGludDogJ1N5bWJvbEJ5TmFtZVJlcScsXG4gICAgICAgICAgICB0eXBlRnVsbE5hbWU6IHF1YWxpZmllZE5hbWVcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY2xpZW50LnBvc3QobXNnKTtcbiAgICB9XG4gICAgICAgIFxuICAgIGZ1bmN0aW9uIGZvcm1hdFNvdXJjZUZpbGUocGF0aCwgY29udGVudHMsIGNhbGxiYWNrKSB7XG4gICAgICAgIHJldHVybiB3aXRoVGVtcEZpbGUocGF0aCwgY29udGVudHMpLnRoZW4oKHRlbXBGaWxlUGF0aCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVxID0ge1xuICAgICAgICAgICAgICAgIHR5cGVoaW50OiBcIkZvcm1hdE9uZVNvdXJjZVJlcVwiLFxuICAgICAgICAgICAgICAgIGZpbGU6IHtcbiAgICAgICAgICAgICAgICAgICAgZmlsZTogcGF0aCxcbiAgICAgICAgICAgICAgICAgICAgY29udGVudHNJbjogdGVtcEZpbGVQYXRoXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGNsaWVudC5wb3N0KHJlcSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgZnVuY3Rpb24gZ2V0SW1wbGljaXRJbmZvKHBhdGg6IHN0cmluZywgc3RhcnRPOiBudW1iZXIsIGVuZE86IG51bWJlcikge1xuICAgICAgICBjb25zdCBtc2cgPSB7XG4gICAgICAgICAgICBcInR5cGVoaW50XCI6XCJJbXBsaWNpdEluZm9SZXFcIixcbiAgICAgICAgICAgIFwiZmlsZVwiOiBwYXRoLFxuICAgICAgICAgICAgXCJyYW5nZVwiOiB7XG4gICAgICAgICAgICAgICAgXCJmcm9tXCI6IHN0YXJ0TyxcbiAgICAgICAgICAgICAgICBcInRvXCI6IGVuZE9cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY2xpZW50LnBvc3QobXNnKVxuICAgIH1cblxuXG4gICAgZnVuY3Rpb24gdHlwZWNoZWNrQWxsKCkge1xuICAgICAgICBjbGllbnQucG9zdCh7XCJ0eXBlaGludFwiOiBcIlR5cGVjaGVja0FsbFJlcVwifSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdW5sb2FkQWxsKCkge1xuICAgICAgICBjbGllbnQucG9zdCh7XCJ0eXBlaGludFwiOiBcIlVubG9hZEFsbFJlcVwifSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0UmVmYWN0b3JpbmdQYXRjaChwcm9jSWQ6IG51bWJlciwgcmVmYWN0b3Jpbmc6IFJlZmFjdG9yaW5nRGVzYykge1xuICAgICAgICBjb25zdCByZXEgPSB7XG4gICAgICAgICAgICB0eXBlaGludDogJ1JlZmFjdG9yUmVxJyxcbiAgICAgICAgICAgIHByb2NJZDogcHJvY0lkLFxuICAgICAgICAgICAgcGFyYW1zOiByZWZhY3RvcmluZyxcbiAgICAgICAgICAgIGludGVyYWN0aXZlOiBmYWxzZVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjbGllbnQucG9zdChyZXEpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHNlYXJjaFB1YmxpY1N5bWJvbHMoa2V5d29yZHM6IHN0cmluZ1tdLCBtYXhTeW1ib2xzOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIGNsaWVudC5wb3N0KHtcbiAgICAgICAgICAgIHR5cGVoaW50OiBcIlB1YmxpY1N5bWJvbFNlYXJjaFJlcVwiLFxuICAgICAgICAgICAga2V5d29yZHM6IGtleXdvcmRzLFxuICAgICAgICAgICAgbWF4UmVzdWx0czogbWF4U3ltYm9sc1xuICAgICAgICB9KVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldERvY1VyaUF0UG9pbnQoZmlsZTogc3RyaW5nLCBwb2ludDogUG9pbnQpIHtcbiAgICAgICAgcmV0dXJuIGNsaWVudC5wb3N0KHtcbiAgICAgICAgICAgIHR5cGVoaW50OiBcIkRvY1VyaUF0UG9pbnRSZXFcIixcbiAgICAgICAgICAgIGZpbGU6IGZpbGUsXG4gICAgICAgICAgICBwb2ludDogcG9pbnRcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0SW1wb3J0U3VnZ2VzdGlvbnMoZmlsZTogc3RyaW5nLCBjaGFyYWN0ZXJJbmRleDogbnVtYmVyLCBzeW1ib2w6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gY2xpZW50LnBvc3Qoe1xuICAgICAgICAgICAgdHlwZWhpbnQ6ICdJbXBvcnRTdWdnZXN0aW9uc1JlcScsXG4gICAgICAgICAgICBmaWxlOiBmaWxlLFxuICAgICAgICAgICAgcG9pbnQ6IGNoYXJhY3RlckluZGV4LFxuICAgICAgICAgICAgbmFtZXM6IFtzeW1ib2xdLFxuICAgICAgICAgICAgbWF4UmVzdWx0czogMTBcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgZ2V0Q29tcGxldGlvbnMsXG4gICAgICAgIGdldFN5bWJvbEF0UG9pbnQsXG4gICAgICAgIHR5cGVjaGVja0ZpbGUsXG4gICAgICAgIHR5cGVjaGVja0J1ZmZlcixcbiAgICAgICAgc3ltYm9sQnlOYW1lLFxuICAgICAgICBmb3JtYXRTb3VyY2VGaWxlLFxuICAgICAgICBnZXRJbXBsaWNpdEluZm8sXG4gICAgICAgIHR5cGVjaGVja0FsbCxcbiAgICAgICAgdW5sb2FkQWxsLFxuICAgICAgICBnZXRSZWZhY3RvcmluZ1BhdGNoLFxuICAgICAgICBzZWFyY2hQdWJsaWNTeW1ib2xzLFxuICAgICAgICBnZXREb2NVcmlBdFBvaW50LFxuICAgICAgICBnZXRJbXBvcnRTdWdnZXN0aW9uc1xuICAgIH1cbn1cblxuXG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBpIHtcbiAgICBnZXRDb21wbGV0aW9uczogKGZpbGVQYXRoOiBzdHJpbmcsIGJ1ZmZlclRleHQ6IGFueSwgb2Zmc2V0OiBhbnksIG5vT2ZBdXRvY29tcGxldGVTdWdnZXN0aW9uczogYW55KSA9PiBQcm9taXNlTGlrZTxDb21wbGV0aW9uc1Jlc3BvbnNlPjtcbiAgICBnZXRTeW1ib2xBdFBvaW50OiAocGF0aDogc3RyaW5nLCBvZmZzZXQ6IGFueSkgPT4gUHJvbWlzZUxpa2U8U3ltYm9sSW5mbz47XG4gICAgdHlwZWNoZWNrRmlsZTogKHBhdGg6IHN0cmluZykgPT4gUHJvbWlzZUxpa2U8VHlwZWhpbnRlZD47XG4gICAgdHlwZWNoZWNrQnVmZmVyOiAocGF0aDogc3RyaW5nLCB0ZXh0OiBzdHJpbmcpID0+IHZvaWQ7XG4gICAgc3ltYm9sQnlOYW1lOiAocXVhbGlmaWVkTmFtZTogYW55KSA9PiBQcm9taXNlTGlrZTxUeXBlaGludGVkPjtcbiAgICBmb3JtYXRTb3VyY2VGaWxlOiAocGF0aDogYW55LCBjb250ZW50czogYW55LCBjYWxsYmFjazogYW55KSA9PiBQcm9taXNlTGlrZTxUeXBlaGludGVkPjtcbiAgICBnZXRJbXBsaWNpdEluZm86IChwYXRoOiBzdHJpbmcsIHN0YXJ0TzogbnVtYmVyLCBlbmRPOiBudW1iZXIpID0+IFByb21pc2VMaWtlPFR5cGVoaW50ZWQ+O1xuICAgIHR5cGVjaGVja0FsbCgpOiB2b2lkO1xuICAgIHVubG9hZEFsbCgpOiB2b2lkO1xuICAgIGdldFJlZmFjdG9yaW5nUGF0Y2g6IChwcm9jSWQ6IG51bWJlciwgcmVmYWN0b3Jpbmc6IFJlZmFjdG9yaW5nRGVzYykgPT4gUHJvbWlzZUxpa2U8VHlwZWhpbnRlZD47XG4gICAgc2VhcmNoUHVibGljU3ltYm9scyhrZXl3b3Jkczogc3RyaW5nW10sIG1heFN5bWJvbHM6IG51bWJlcik6IFByb21pc2VMaWtlPFR5cGVoaW50ZWQ+O1xuICAgIGdldERvY1VyaUF0UG9pbnQoZmlsZTogc3RyaW5nLCBwb2ludDogUG9pbnQpOiBQcm9taXNlTGlrZTxUeXBlaGludGVkPjtcbiAgICBnZXRJbXBvcnRTdWdnZXN0aW9ucyhmaWxlOiBzdHJpbmcsIGNoYXJhY3RlckluZGV4OiBudW1iZXIsIHN5bWJvbDogc3RyaW5nKTogUHJvbWlzZUxpa2U8VHlwZWhpbnRlZD47XG59XG4iXX0=
