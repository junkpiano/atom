"use strict";
var fs = require('fs');
var path = require('path');
var Promise = require('bluebird');
var child_process_1 = require('child_process');
var _ = require('lodash');
var loglevel = require('loglevel');
var download = require('download');
var file_utils_1 = require('./file-utils');
function proxyArgs(proxySettings) {
    var args = [];
    if (proxySettings != undefined) {
        args.push('-Dhttp.proxyHost=' + proxySettings.host);
        args.push('-Dhttps.proxyHost=' + proxySettings.host);
        args.push('-Dhttp.proxyPort=' + proxySettings.port);
        args.push('-Dhttps.proxyPort=' + proxySettings.port);
        if (proxySettings.user != undefined) {
            args.push('-Dhttp.proxyUser=' + proxySettings.user);
            args.push('-Dhttps.proxyUser=' + proxySettings.user);
        }
        if (proxySettings.password != undefined) {
            args.push('-Dhttp.proxyPassword=' + proxySettings.password);
            args.push('-Dhttps.proxyPassword=' + proxySettings.password);
        }
    }
    return args;
}
function javaArgs(dotEnsime, serverVersion, updateChanging) {
    var scalaVersion = dotEnsime.scalaVersion;
    var scalaEdition = dotEnsime.scalaEdition;
    var args = [
        '-noverify',
        '-jar', './coursier',
        'fetch'
    ];
    if (updateChanging) {
        args.push('-m', 'update-changing');
    }
    args.push('-r', 'file:///$HOME/.m2/repository', '-r', 'https://oss.sonatype.org/content/repositories/snapshots', '-r', 'https://jcenter.bintray.com/', "org.ensime:ensime_" + scalaEdition + ":" + serverVersion, '-V', "org.scala-lang:scala-compiler:" + scalaVersion, '-V', "org.scala-lang:scala-library:" + scalaVersion, '-V', "org.scala-lang:scala-reflect:" + scalaVersion, '-V', "org.scala-lang:scalap:" + scalaVersion);
    return args;
}
// Updates ensime server, invoke callback when done
function updateServer(tempdir, failure, getPidLogger, proxySettings) {
    var logger = loglevel.getLogger('ensime.server-update');
    logger.debug('update ensime server, tempdir: ' + tempdir);
    return function doUpdateServer(parsedDotEnsime, ensimeServerVersion, classpathFile) {
        logger.debug('trying to update server with coursierâ€¦');
        return file_utils_1.ensureExists(parsedDotEnsime.cacheDir).then(function (cacheDir) {
            console.log('cachedir: ', cacheDir);
            return new Promise(function (resolve, reject) {
                function runCoursier() {
                    var javaCmd = (parsedDotEnsime.javaHome) ?
                        path.join(parsedDotEnsime.javaHome, 'bin', 'java')
                        :
                            "java";
                    var spaceSeparatedClassPath = "";
                    var args = proxyArgs(proxySettings).concat(javaArgs(parsedDotEnsime, ensimeServerVersion, true));
                    logger.debug('java command to spawn', javaCmd, args, tempdir);
                    var pid = child_process_1.spawn(javaCmd, args, { cwd: tempdir });
                    var pidLogger = getPidLogger();
                    pid.stdout.on('data', function (chunk) {
                        var s = chunk.toString('utf8');
                        logger.debug('got data from java process', s);
                        if (pidLogger)
                            pidLogger(s);
                        spaceSeparatedClassPath += chunk.toString('utf8');
                    });
                    pid.stderr.on('data', function (chunk) {
                        var s = chunk.toString('utf8');
                        logger.debug('coursier: ', s);
                        if (pidLogger)
                            pidLogger(s);
                    });
                    pid.stdin.end();
                    pid.on('close', function (exitCode) {
                        if (exitCode == 0) {
                            var classpath = _.join(_.split(_.trim(spaceSeparatedClassPath), /\s/), path.delimiter);
                            logger.debug(['classpath', classpath]);
                            fs.writeFile(classpathFile, classpath, resolve);
                        }
                        else {
                            logger.error('Ensime server update failed, exitCode: ', exitCode);
                            failure("Ensime server update failed", exitCode);
                            reject(exitCode);
                        }
                    });
                }
                logger.debug("checking tempdir: " + tempdir);
                if (!fs.existsSync(tempdir)) {
                    logger.debug("tempdir didn't exist, creating: " + tempdir);
                    fs.mkdirSync(tempdir);
                }
                if (fs.existsSync(tempdir + path.sep + 'coursier')) {
                    logger.debug("pre-existing coursier binary, downloading: " + tempdir);
                    runCoursier();
                }
                else {
                    logger.trace("no pre-existing coursier binary, downloading: " + tempdir);
                    var coursierUrl = 'https://git.io/vgvpD'; // Java 7
                    download({ mode: '0755' }).get(coursierUrl).dest(tempdir).rename('coursier').run(function (err) {
                        if (err) {
                            logger.error("failed to download coursier");
                            failure("Failed to download coursier", err);
                            reject(err);
                        }
                        else {
                            logger.debug("downloaded coursier, now running:");
                            runCoursier();
                        }
                    });
                }
            });
        });
    };
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = updateServer;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9lbnNpbWUtc2VydmVyLXVwZGF0ZS1jb3Vyc2llci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsSUFBTyxFQUFFLFdBQVcsSUFBSSxDQUFDLENBQUM7QUFDMUIsSUFBTyxJQUFJLFdBQVcsTUFBTSxDQUFDLENBQUM7QUFDOUIsSUFBWSxPQUFPLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFFcEMsOEJBQW9CLGVBQWUsQ0FBQyxDQUFBO0FBQ3BDLElBQU8sQ0FBQyxXQUFXLFFBQVEsQ0FBQyxDQUFDO0FBQzdCLElBQU8sUUFBUSxXQUFXLFVBQVUsQ0FBQyxDQUFDO0FBRXRDLElBQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNyQywyQkFBMkIsY0FFM0IsQ0FBQyxDQUZ3QztBQUV6QyxtQkFBbUIsYUFBNkI7SUFDOUMsSUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ2hCLEVBQUUsQ0FBQyxDQUFDLGFBQWEsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JELEVBQUUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNwQyxJQUFJLENBQUMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNwRCxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLGFBQWEsQ0FBQyxJQUFJ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QUFHO3dCQUNuRixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDOzRCQUNSLE1BQU0sQ0FBQyxLQUFLLENBQUMsNkJBQTZCLENBQUMsQ0FBQTs0QkFDM0MsT0FBTyxDQUFDLDZCQUE2QixFQUFFLEdBQUcsQ0FBQyxDQUFBOzRCQUMzQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7d0JBQ2IsQ0FBQzt3QkFBQyxJQUFJLENBQUMsQ0FBQzs0QkFDTixNQUFNLENBQUMsS0FBSyxDQUFDLG1DQUFtQyxDQUFDLENBQUE7NEJBQ2pELFdBQVcsRUFBRSxDQUFBO3dCQUNmLENBQUM7b0JBQ0gsQ0FBQyxDQUFDLENBQUM7Z0JBQ0wsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUE7QUFDSCxDQUFDO0FBL0VEOzhCQStFQyxDQUFBIiwiZmlsZSI6ImxpYi9lbnNpbWUtc2VydmVyLXVwZGF0ZS1jb3Vyc2llci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuXG5pbXBvcnQge3NwYXdufSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5pbXBvcnQgbG9nbGV2ZWwgPSByZXF1aXJlKCdsb2dsZXZlbCcpO1xuaW1wb3J0IHtEb3RFbnNpbWUsIFByb3h5U2V0dGluZ3N9IGZyb20gJy4vdHlwZXMnO1xuY29uc3QgZG93bmxvYWQgPSByZXF1aXJlKCdkb3dubG9hZCcpO1xuaW1wb3J0IHtlbnN1cmVFeGlzdHN9IGZyb20gJy4vZmlsZS11dGlscydcblxuZnVuY3Rpb24gcHJveHlBcmdzKHByb3h5U2V0dGluZ3M/OiBQcm94eVNldHRpbmdzKSB7XG4gIGNvbnN0IGFyZ3MgPSBbXTtcbiAgaWYgKHByb3h5U2V0dGluZ3MgIT0gdW5kZWZpbmVkKSB7XG4gICAgYXJncy5wdXNoKCctRGh0dHAucHJveHlIb3N0PScgKyBwcm94eVNldHRpbmdzLmhvc3QpO1xuICAgIGFyZ3MucHVzaCgnLURodHRwcy5wcm94eUhvc3Q9JyArIHByb3h5U2V0dGluZ3MuaG9zdCk7XG4gICAgYXJncy5wdXNoKCctRGh0dHAucHJveHlQb3J0PScgKyBwcm94eVNldHRpbmdzLnBvcnQpO1xuICAgIGFyZ3MucHVzaCgnLURodHRwcy5wcm94eVBvcnQ9JyArIHByb3h5U2V0dGluZ3MucG9ydCk7XG4gICAgaWYgKHByb3h5U2V0dGluZ3MudXNlciAhPSB1bmRlZmluZWQpIHtcbiAgICAgIGFyZ3MucHVzaCgnLURodHRwLnByb3h5VXNlcj0nICsgcHJveHlTZXR0aW5ncy51c2VyKTtcbiAgICAgIGFyZ3MucHVzaCgnLURodHRwcy5wcm94eVVzZXI9JyArIHByb3h5U2V0dGluZ3MudXNlcik7XG4gICAgfVxuICAgIGlmIChwcm94eVNldHRpbmdzLnBhc3N3b3JkICE9IHVuZGVmaW5lZCkge1xuICAgICAgYXJncy5wdXNoKCctRGh0dHAucHJveHlQYXNzd29yZD0nICsgcHJveHlTZXR0aW5ncy5wYXNzd29yZCk7XG4gICAgICBhcmdzLnB1c2goJy1EaHR0cHMucHJveHlQYXNzd29yZD0nICsgcHJveHlTZXR0aW5ncy5wYXNzd29yZCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBhcmdzO1xufVxuXG5mdW5jdGlvbiBqYXZhQXJncyhkb3RFbnNpbWU6IERvdEVuc2ltZSwgc2VydmVyVmVyc2lvbjogU3RyaW5nLCB1cGRhdGVDaGFuZ2luZzogYm9vbGVhbikge1xuICBjb25zdCBzY2FsYVZlcnNpb24gPSBkb3RFbnNpbWUuc2NhbGFWZXJzaW9uXG4gIGNvbnN0IHNjYWxhRWRpdGlvbiA9IGRvdEVuc2ltZS5zY2FsYUVkaXRpb25cbiAgY29uc3QgYXJncyA9XG4gICAgW1xuICAgICAgJy1ub3ZlcmlmeScsIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbGV4YXJjaGFtYmF1bHQvY291cnNpZXIvaXNzdWVzLzE3NiNpc3N1ZWNvbW1lbnQtMTg4NzcyNjg1XG4gICAgICAnLWphcicsICcuL2NvdXJzaWVyJyxcbiAgICAgICdmZXRjaCdcbiAgICBdXG4gIGlmICh1cGRhdGVDaGFuZ2luZykge1xuICAgIGFyZ3MucHVzaCgnLW0nLCAndXBkYXRlLWNoYW5naW5nJyk7XG4gIH1cbiAgYXJncy5wdXNoKFxuICAgICctcicsICdmaWxlOi8vLyRIT01FLy5tMi9yZXBvc2l0b3J5JyxcbiAgICAnLXInLCAnaHR0cHM6Ly9vc3Muc29uYXR5cGUub3JnL2NvbnRlbnQvcmVwb3NpdG9yaWVzL3NuYXBzaG90cycsXG4gICAgJy1yJywgJ2h0dHBzOi8vamNlbnRlci5iaW50cmF5LmNvbS8nLFxuICAgIGBvcmcuZW5zaW1lOmVuc2ltZV8ke3NjYWxhRWRpdGlvbn06JHtzZXJ2ZXJWZXJzaW9ufWAsXG4gICAgJy1WJywgYG9yZy5zY2FsYS1sYW5nOnNjYWxhLWNvbXBpbGVyOiR7c2NhbGFWZXJzaW9ufWAsXG4gICAgJy1WJywgYG9yZy5zY2FsYS1sYW5nOnNjYWxhLWxpYnJhcnk6JHtzY2FsYVZlcnNpb259YCxcbiAgICAnLVYnLCBgb3JnLnNjYWxhLWxhbmc6c2NhbGEtcmVmbGVjdDoke3NjYWxhVmVyc2lvbn1gLFxuICAgICctVicsIGBvcmcuc2NhbGEtbGFuZzpzY2FsYXA6JHtzY2FsYVZlcnNpb259YFxuICApO1xuICByZXR1cm4gYXJncztcbn1cblxuLy8gVXBkYXRlcyBlbnNpbWUgc2VydmVyLCBpbnZva2UgY2FsbGJhY2sgd2hlbiBkb25lXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB1cGRhdGVTZXJ2ZXIodGVtcGRpcjogc3RyaW5nLCBmYWlsdXJlOiAoc3RyaW5nLCBpbnQpID0+IHZvaWQsIGdldFBpZExvZ2dlcjogKCkgPT4gKHN0cmluZykgPT4gdm9pZCwgcHJveHlTZXR0aW5ncz86UHJveHlTZXR0aW5ncykge1xuICBjb25zdCBsb2dnZXIgPSBsb2dsZXZlbC5nZXRMb2dnZXIoJ2Vuc2ltZS5zZXJ2ZXItdXBkYXRlJylcbiAgbG9nZ2VyLmRlYnVnKCd1cGRhdGUgZW5zaW1lIHNlcnZlciwgdGVtcGRpcjogJyArIHRlbXBkaXIpXG5cbiAgcmV0dXJuIGZ1bmN0aW9uIGRvVXBkYXRlU2VydmVyKHBhcnNlZERvdEVuc2ltZTogRG90RW5zaW1lLCBlbnNpbWVTZXJ2ZXJWZXJzaW9uOiBzdHJpbmcsIGNsYXNzcGF0aEZpbGU6IHN0cmluZyk6IFByb21pc2VMaWtlPGFueT4ge1xuICAgIGxvZ2dlci5kZWJ1ZygndHJ5aW5nIHRvIHVwZGF0ZSBzZXJ2ZXIgd2l0aCBjb3Vyc2llcuKApicpXG5cbiAgICByZXR1cm4gZW5zdXJlRXhpc3RzKHBhcnNlZERvdEVuc2ltZS5jYWNoZURpcikudGhlbigoY2FjaGVEaXIpID0+IHtcblxuXG4gICAgICBjb25zb2xlLmxvZygnY2FjaGVkaXI6ICcsIGNhY2hlRGlyKVxuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgZnVuY3Rpb24gcnVuQ291cnNpZXIoKSB7XG4gICAgICAgICAgY29uc3QgamF2YUNtZCA9IChwYXJzZWREb3RFbnNpbWUuamF2YUhvbWUpID9cbiAgICAgICAgICAgIHBhdGguam9pbihwYXJzZWREb3RFbnNpbWUuamF2YUhvbWUsICdiaW4nLCAnamF2YScpXG4gICAgICAgICAgICA6XG4gICAgICAgICAgICBcImphdmFcIlxuXG4gICAgICAgICAgbGV0IHNwYWNlU2VwYXJhdGVkQ2xhc3NQYXRoID0gXCJcIlxuXG4gICAgICAgICAgY29uc3QgYXJncyA9IHByb3h5QXJncyhwcm94eVNldHRpbmdzKS5jb25jYXQoamF2YUFyZ3MocGFyc2VkRG90RW5zaW1lLCBlbnNpbWVTZXJ2ZXJWZXJzaW9uLCB0cnVlKSlcblxuICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnamF2YSBjb21tYW5kIHRvIHNwYXduJywgamF2YUNtZCwgYXJncywgdGVtcGRpcilcbiAgICAgICAgICBjb25zdCBwaWQgPSBzcGF3bihqYXZhQ21kLCBhcmdzLCB7IGN3ZDogdGVtcGRpciB9KVxuICAgICAgICAgIGNvbnN0IHBpZExvZ2dlciA9IGdldFBpZExvZ2dlcigpXG4gICAgICAgICAgcGlkLnN0ZG91dC5vbignZGF0YScsIChjaHVuaykgPT4ge1xuICAgICAgICAgICAgY29uc3QgcyA9IGNodW5rLnRvU3RyaW5nKCd1dGY4JylcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnZ290IGRhdGEgZnJvbSBqYXZhIHByb2Nlc3MnLCBzKVxuICAgICAgICAgICAgaWYocGlkTG9nZ2VyKSBwaWRMb2dnZXIocylcbiAgICAgICAgICAgIHNwYWNlU2VwYXJhdGVkQ2xhc3NQYXRoICs9IGNodW5rLnRvU3RyaW5nKCd1dGY4JylcbiAgICAgICAgICB9KVxuICAgICAgICAgIHBpZC5zdGRlcnIub24oJ2RhdGEnLCAoY2h1bmspID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHMgPSBjaHVuay50b1N0cmluZygndXRmOCcpXG4gICAgICAgICAgICBsb2dnZXIuZGVidWcoJ2NvdXJzaWVyOiAnLCBzKVxuICAgICAgICAgICAgaWYocGlkTG9nZ2VyKSBwaWRMb2dnZXIocylcbiAgICAgICAgICB9KVxuXG4gICAgICAgICAgcGlkLnN0ZGluLmVuZCgpXG5cbiAgICAgICAgICBwaWQub24oJ2Nsb3NlJywgKGV4aXRDb2RlKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXhpdENvZGUgPT0gMCkge1xuICAgICAgICAgICAgICBjb25zdCBjbGFzc3BhdGggPSBfLmpvaW4oXy5zcGxpdChfLnRyaW0oc3BhY2VTZXBhcmF0ZWRDbGFzc1BhdGgpLCAvXFxzLyksIHBhdGguZGVsaW1pdGVyKVxuICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoWydjbGFzc3BhdGgnLCBjbGFzc3BhdGhdKVxuICAgICAgICAgICAgICBmcy53cml0ZUZpbGUoY2xhc3NwYXRoRmlsZSwgY2xhc3NwYXRoLCByZXNvbHZlKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCdFbnNpbWUgc2VydmVyIHVwZGF0ZSBmYWlsZWQsIGV4aXRDb2RlOiAnLCBleGl0Q29kZSlcbiAgICAgICAgICAgICAgZmFpbHVyZShcIkVuc2ltZSBzZXJ2ZXIgdXBkYXRlIGZhaWxlZFwiLCBleGl0Q29kZSlcbiAgICAgICAgICAgICAgcmVqZWN0KGV4aXRDb2RlKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgbG9nZ2VyLmRlYnVnKFwiY2hlY2tpbmcgdGVtcGRpcjogXCIgKyB0ZW1wZGlyKVxuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmModGVtcGRpcikpIMKge1xuICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhcInRlbXBkaXIgZGlkbid0IGV4aXN0LCBjcmVhdGluZzogXCIgKyB0ZW1wZGlyKVxuICAgICAgICAgIGZzLm1rZGlyU3luYyh0ZW1wZGlyKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmModGVtcGRpciArIHBhdGguc2VwICsgJ2NvdXJzaWVyJykpIHtcbiAgICAgICAgICBsb2dnZXIuZGVidWcoXCJwcmUtZXhpc3RpbmcgY291cnNpZXIgYmluYXJ5LCBkb3dubG9hZGluZzogXCIgKyB0ZW1wZGlyKVxuICAgICAgICAgIHJ1bkNvdXJzaWVyKClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsb2dnZXIudHJhY2UoXCJubyBwcmUtZXhpc3RpbmcgY291cnNpZXIgYmluYXJ5LCBkb3dubG9hZGluZzogXCIgKyB0ZW1wZGlyKVxuICAgICAgICAgIGNvbnN0IGNvdXJzaWVyVXJsID0gJ2h0dHBzOi8vZ2l0LmlvL3ZndnBEJyAvLyBKYXZhIDdcblxuICAgICAgICAgIGRvd25sb2FkKHsgbW9kZTogJzA3NTUnIH0pLmdldChjb3Vyc2llclVybCkuZGVzdCh0ZW1wZGlyKS5yZW5hbWUoJ2NvdXJzaWVyJykucnVuKChlcnIpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFwiZmFpbGVkIHRvIGRvd25sb2FkIGNvdXJzaWVyXCIpXG4gICAgICAgICAgICAgIGZhaWx1cmUoXCJGYWlsZWQgdG8gZG93bmxvYWQgY291cnNpZXJcIiwgZXJyKVxuICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKFwiZG93bmxvYWRlZCBjb3Vyc2llciwgbm93IHJ1bm5pbmc6XCIpXG4gICAgICAgICAgICAgIHJ1bkNvdXJzaWVyKClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==
